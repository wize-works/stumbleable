# GitHub Copilot Instructions for **Stumbleable Mobile**

> **Purpose:** Guide Copilot to build the **Stumbleable Mobile App** — a React Native/Expo implementation of the Stumbleable discovery experience optimized for iOS and Android devices.

---

## 🎯 Mobile Project Overview
**Stumbleable Mobile** brings the core serendipity experience to mobile devices using React Native and Expo. The app leverages the existing microservices architecture while providing mobile-native UX patterns and platform integrations.

### Mobile-Specific Principles
- **Thumb-first design** — All interactions optimized for one-handed use
- **Gesture-driven navigation** — Swipes, long-presses, pull-to-refresh
- **Native platform integration** — Share sheets, haptics, biometric auth
- **Cross-platform sync** — Seamless data sync with web platform
- **Performance-first** — <3s cold start, <2s stumble response
- **Battery conscious** — Minimal background processing

---

## 📁 Mobile App Structure

```
mobile/expo/
├── app/                           # Expo Router file-based routing
│   ├── (tabs)/                   # Tab navigation layout
│   │   ├── stumble.tsx           # Main discovery screen
│   │   ├── saved.tsx             # Saved discoveries
│   │   ├── lists.tsx             # Lists management
│   │   └── settings.tsx          # User settings
│   ├── (auth)/                   # Authentication screens
│   │   ├── sign-in.tsx          # Sign in screen
│   │   ├── sign-up.tsx          # Sign up screen
│   │   └── onboarding.tsx       # Topic selection
│   ├── discovery/
│   │   └── [id].tsx             # Individual discovery detail
│   ├── lists/
│   │   └── [id].tsx             # List detail screen
│   ├── _layout.tsx              # Root layout with auth
│   └── +not-found.tsx           # 404 screen
├── components/                   # Reusable components
│   ├── StumbleCard.tsx          # Discovery card component
│   ├── ReactionBar.tsx          # Like/Skip/Save/Share buttons
│   ├── WildnessSlider.tsx       # Exploration control
│   ├── TabBar.tsx               # Custom tab bar
│   ├── LoadingState.tsx         # Loading indicators
│   └── EmptyState.tsx           # Empty state screens
├── lib/                         # Utilities and services
│   ├── api-client.ts           # API integration with services
│   ├── auth.ts                 # Clerk authentication
│   ├── storage.ts              # AsyncStorage utilities
│   ├── haptics.ts              # Haptic feedback
│   ├── notifications.ts        # Push notifications
│   └── utils.ts                # General utilities
├── hooks/                       # Custom React hooks
│   ├── useStumble.ts           # Stumble logic and state
│   ├── useAuth.ts              # Authentication state
│   ├── useNetworkStatus.ts     # Network connectivity
│   └── useSwipeGestures.ts     # Gesture handling
├── constants/                   # App constants
│   ├── Colors.ts               # Theme colors
│   ├── Layout.ts               # Screen dimensions
│   └── Config.ts               # Environment config
├── types/                       # TypeScript definitions
│   ├── api.ts                  # API response types
│   ├── navigation.ts           # Navigation types
│   └── discovery.ts            # Discovery data types
├── assets/                      # Static assets
│   ├── images/                 # App images and icons
│   ├── fonts/                  # Custom fonts
│   └── sounds/                 # Haptic/audio feedback
├── app.config.ts               # Expo configuration
├── package.json               # Dependencies and scripts
├── tsconfig.json              # TypeScript configuration
├── babel.config.js            # Babel configuration
└── metro.config.js            # Metro bundler configuration
```

---

## 🧰 Mobile Tech Stack

### Core Framework
- **Expo SDK 50+** with managed workflow
- **React Native** with TypeScript strict mode
- **Expo Router** for file-based navigation
- **Expo Dev Client** for custom native code

### UI & Interactions
- **React Native Reanimated 3** for smooth animations
- **React Native Gesture Handler** for swipe/touch
- **Expo Haptics** for tactile feedback
- **React Native Safe Area Context** for screen boundaries

### State Management & Data
- **Zustand** for client state management
- **React Query** for API caching and sync
- **AsyncStorage** for offline persistence
- **Expo SecureStore** for sensitive data (tokens)

### Platform Integration
- **Clerk Expo SDK** for authentication
- **Expo Notifications** for push notifications
- **Expo WebBrowser** for in-app web viewing
- **Expo Sharing** for native sharing
- **Expo AuthSession** for OAuth flows

### Development & Build
- **EAS Build** for cloud builds and distribution
- **EAS Submit** for app store deployment
- **Expo Constants** for environment management
- **Metro** bundler with TypeScript support

---

## 🎨 Mobile Design System

### Colors & Theme
```typescript
// Use same color system as web but adapted for mobile
export const Colors = {
  light: {
    primary: '#6366f1',        // Indigo-500
    secondary: '#8b5cf6',      // Violet-500
    background: '#ffffff',      // White
    surface: '#f8fafc',        // Slate-50
    text: '#0f172a',           // Slate-900
    textSecondary: '#64748b',  // Slate-500
  },
  dark: {
    primary: '#818cf8',        // Indigo-400
    secondary: '#a78bfa',      // Violet-400
    background: '#0f172a',     // Slate-900
    surface: '#1e293b',       // Slate-800
    text: '#f8fafc',          // Slate-50
    textSecondary: '#94a3b8',  // Slate-400
  },
};
```

### Typography
```typescript
export const Typography = {
  title: {
    fontSize: 28,
    fontWeight: '700',
    lineHeight: 34,
  },
  heading: {
    fontSize: 20,
    fontWeight: '600', 
    lineHeight: 28,
  },
  body: {
    fontSize: 16,
    fontWeight: '400',
    lineHeight: 24,
  },
  caption: {
    fontSize: 14,
    fontWeight: '500',
    lineHeight: 20,
  },
};
```

### Spacing & Layout
```typescript
export const Layout = {
  spacing: {
    xs: 4,
    sm: 8,
    md: 16,
    lg: 24,
    xl: 32,
    xxl: 48,
  },
  borderRadius: {
    sm: 8,
    md: 12,
    lg: 16,
    xl: 24,
  },
  touchTarget: 44, // Minimum iOS touch target
};
```

---

## 🔌 API Integration

### Service Endpoints
Use the same microservices as the web platform:
- **Discovery Service**: `http://localhost:7001/api`
- **Interaction Service**: `http://localhost:7002/api`  
- **User Service**: `http://localhost:7003/api`

### API Client Pattern
```typescript
// lib/api-client.ts
import { QueryClient } from '@tanstack/react-query';
import Constants from 'expo-constants';

const API_BASE_URLS = {
  discovery: Constants.expoConfig?.extra?.discoveryApiUrl || 'http://localhost:7001/api',
  interaction: Constants.expoConfig?.extra?.interactionApiUrl || 'http://localhost:7002/api',
  user: Constants.expoConfig?.extra?.userApiUrl || 'http://localhost:7003/api',
};

export class DiscoveryAPI {
  static async getNext(params: GetNextParams): Promise<Discovery> {
    const response = await fetch(`${API_BASE_URLS.discovery}/next`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params),
    });
    return response.json();
  }
}
```

### Environment Configuration
```typescript
// app.config.ts
export default {
  expo: {
    extra: {
      discoveryApiUrl: process.env.EXPO_PUBLIC_DISCOVERY_API_URL,
      interactionApiUrl: process.env.EXPO_PUBLIC_INTERACTION_API_URL,
      userApiUrl: process.env.EXPO_PUBLIC_USER_API_URL,
      clerkPublishableKey: process.env.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY,
    },
  },
};
```

---

## 📱 Mobile UX Patterns

### Gesture Vocabulary
```typescript
// Standard gesture patterns for Stumbleable Mobile
export const GesturePatterns = {
  // Primary actions
  TAP: 'Single tap for primary actions (stumble, react)',
  LONG_PRESS: 'Long press for context menus and secondary actions',
  
  // Navigation gestures
  SWIPE_RIGHT: 'Swipe right for next stumble (with elastic bounce)',
  SWIPE_LEFT: 'Swipe left for previous stumble (if available)',
  SWIPE_UP: 'Swipe up on card to expand to full article view',
  SWIPE_DOWN: 'Swipe down to return from full article to card',
  
  // Refresh and loading
  PULL_TO_REFRESH: 'Pull down to refresh discovery pool',
  
  // Article interaction
  PINCH_ZOOM: 'Pinch to zoom in full article view',
  DOUBLE_TAP: 'Double tap card for quick like action',
};
```

### Haptic Feedback
```typescript
// lib/haptics.ts
import * as Haptics from 'expo-haptics';

export const HapticFeedback = {
  light: () => Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light),
  medium: () => Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium),
  heavy: () => Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Heavy),
  selection: () => Haptics.selectionAsync(),
  success: () => Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success),
  error: () => Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error),
};

// Usage patterns:
// - Light: Button taps, reactions
// - Medium: Stumble action, save action  
// - Heavy: Error states, important confirmations
// - Selection: Slider adjustments, picker changes
```

### Screen Layout Patterns
```typescript
// Standard screen components structure
const StumbleScreen = () => {
  return (
    <SafeAreaView style={styles.container}>
      {/* Fixed header with minimal chrome */}
      <Header />
      
      {/* Main content area - full screen card */}
      <ScrollView contentContainerStyle={styles.content}>
        <StumbleCard discovery={currentDiscovery} />
      </ScrollView>
      
      {/* Fixed bottom bar with reactions */}
      <View style={styles.bottomBar}>
        <ReactionBar />
        <WildnessSlider />
      </View>
      
      {/* Floating action button */}
      <TouchableOpacity style={styles.stumbleButton}>
        <StumbleButton />
      </TouchableOpacity>
    </SafeAreaView>
  );
};
```

---

## 🔐 Authentication Integration

### Clerk Setup
```typescript
// app/_layout.tsx
import { ClerkProvider } from '@clerk/clerk-expo';
import Constants from 'expo-constants';

export default function RootLayout() {
  return (
    <ClerkProvider 
      publishableKey={Constants.expoConfig?.extra?.clerkPublishableKey!}
      tokenCache={tokenCache} // SecureStore integration
    >
      <NavigationContainer>
        <RootNavigator />
      </NavigationContainer>
    </ClerkProvider>
  );
}
```

### Token Storage
```typescript
// lib/auth.ts
import * as SecureStore from 'expo-secure-store';

export const tokenCache = {
  async getToken(key: string) {
    try {
      return SecureStore.getItemAsync(key);
    } catch (err) {
      return null;
    }
  },
  async saveToken(key: string, value: string) {
    try {
      return SecureStore.setItemAsync(key, value);
    } catch (err) {
      return;
    }
  },
};
```

---

## 📊 Performance Guidelines

### React Native Performance
```typescript
// Use React.memo for expensive components
export const StumbleCard = React.memo(({ discovery }: Props) => {
  return (
    <View style={styles.card}>
      {/* Component content */}
    </View>
  );
});

// Use useMemo for expensive calculations
const processedDiscoveries = useMemo(() => {
  return discoveries.map(processDiscovery);
}, [discoveries]);

// Use useCallback for event handlers
const handleLike = useCallback(() => {
  HapticFeedback.light();
  onLike(discovery.id);
}, [discovery.id, onLike]);
```

### Image Optimization
```typescript
// Use Expo Image for better performance
import { Image } from 'expo-image';

<Image
  source={{ uri: discovery.imageUrl }}
  style={styles.image}
  contentFit="cover"
  transition={200}
  recyclingKey={discovery.id} // For FlatList optimization
/>
```

### Memory Management
```typescript
// Limit discovery cache size
const MAX_CACHED_DISCOVERIES = 50;

// Use FlatList for large lists with proper optimization
<FlatList
  data={discoveries}
  keyExtractor={(item) => item.id}
  getItemLayout={getItemLayout} // If fixed height
  removeClippedSubviews={true}
  maxToRenderPerBatch={5}
  windowSize={10}
  initialNumToRender={3}
/>
```

---

## 🎯 Mobile-Specific Features

### Push Notifications
```typescript
// lib/notifications.ts
import * as Notifications from 'expo-notifications';

// Configure notification behavior
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: false,
    shouldSetBadge: false,
  }),
});

// Register for push notifications
export async function registerForPushNotificationsAsync() {
  const { status: existingStatus } = await Notifications.getPermissionsAsync();
  let finalStatus = existingStatus;
  
  if (existingStatus !== 'granted') {
    const { status } = await Notifications.requestPermissionsAsync();
    finalStatus = status;
  }
  
  if (finalStatus !== 'granted') {
    alert('Failed to get push token for push notification!');
    return;
  }
  
  const token = (await Notifications.getExpoPushTokenAsync()).data;
  return token;
}
```

### Deep Linking
```typescript
// app.config.ts - Configure deep links
export default {
  expo: {
    scheme: 'stumbleable',
    web: {
      linking: {
        prefixes: ['https://stumbleable.com', 'stumbleable://'],
        config: {
          screens: {
            '(tabs)': {
              screens: {
                stumble: 'stumble',
                saved: 'saved',
                lists: 'lists',
              },
            },
            'discovery/[id]': 'discovery/:id',
            'lists/[id]': 'lists/:id',
          },
        },
      },
    },
  },
};
```

### Native Sharing
```typescript
// lib/sharing.ts
import * as Sharing from 'expo-sharing';

export const shareDiscovery = async (discovery: Discovery) => {
  try {
    const url = `https://stumbleable.com/discovery/${discovery.id}`;
    const message = `Check out this discovery: ${discovery.title}`;
    
    await Sharing.shareAsync(url, {
      dialogTitle: message,
      mimeType: 'text/plain',
    });
  } catch (error) {
    console.error('Error sharing:', error);
  }
};
```

---

## 🚫 Mobile-Specific Pitfalls to Avoid

### Performance Pitfalls
1. **❌ Excessive re-renders**: Use React.memo and useMemo appropriately
2. **❌ Large image bundles**: Use Expo Image with proper caching
3. **❌ Blocking main thread**: Use InteractionManager for heavy operations
4. **❌ Memory leaks**: Clean up timers, subscriptions, and listeners
5. **❌ Inefficient lists**: Use FlatList with proper optimization props

### Platform Differences
1. **❌ iOS vs Android inconsistencies**: Test on both platforms regularly
2. **❌ Safe area issues**: Always use SafeAreaProvider and SafeAreaView
3. **❌ Navigation gestures**: Handle platform-specific navigation patterns
4. **❌ StatusBar styling**: Configure differently for light/dark modes

### API Integration
1. **❌ Hardcoded localhost URLs**: Use environment variables for API endpoints
2. **❌ Missing error handling**: Handle network failures gracefully
3. **❌ No offline fallbacks**: Show appropriate UI when disconnected
4. **❌ Blocking UI**: Show loading states during API calls

### Expo Specific
1. **❌ Missing expo-dev-client**: Required for custom native code
2. **❌ Wrong SDK version**: Keep Expo SDK and dependencies compatible
3. **❌ Bundle size issues**: Analyze and optimize bundle size regularly
4. **❌ Build configuration**: Proper EAS Build configuration for stores

---

## 🧪 Testing Strategy

### Unit Testing
```typescript
// Use Jest and React Native Testing Library
import { render, fireEvent } from '@testing-library/react-native';
import { StumbleCard } from '../StumbleCard';

test('renders discovery title', () => {
  const discovery = { id: '1', title: 'Test Discovery' };
  const { getByText } = render(<StumbleCard discovery={discovery} />);
  expect(getByText('Test Discovery')).toBeTruthy();
});
```

### E2E Testing
```typescript
// Use Maestro for E2E tests
# flows/stumble-flow.yaml
appId: com.stumbleable.mobile
---
- launchApp
- tapOn: "Start Stumbling"
- assertVisible: "Discovery Card"
- swipe:
    direction: RIGHT
- assertVisible: "Next Discovery"
```

### Performance Testing
```typescript
// Use Flipper for performance profiling
// Monitor:
// - JS thread usage
// - Native thread usage  
// - Memory allocation
// - Network requests
```

---

## 📦 Dependencies & Scripts

### Required Dependencies
```json
{
  "dependencies": {
    "expo": "~50.0.0",
    "react": "18.2.0",
    "react-native": "0.73.0",
    "@clerk/clerk-expo": "^1.0.0",
    "@tanstack/react-query": "^5.0.0",
    "zustand": "^4.0.0",
    "react-native-reanimated": "~3.6.0",
    "react-native-gesture-handler": "~2.14.0",
    "expo-router": "~3.4.0",
    "expo-haptics": "~12.8.0",
    "expo-notifications": "~0.27.0",
    "expo-web-browser": "~12.8.0",
    "expo-sharing": "~11.10.0",
    "expo-secure-store": "~12.9.0",
    "expo-constants": "~15.4.0",
    "expo-image": "~1.10.0"
  }
}
```

### Scripts
```json
{
  "scripts": {
    "start": "expo start",
    "android": "expo run:android",
    "ios": "expo run:ios", 
    "web": "expo start --web",
    "build": "eas build",
    "submit": "eas submit",
    "test": "jest",
    "test:e2e": "maestro test flows/",
    "lint": "eslint .",
    "type-check": "tsc --noEmit"
  }
}
```

---

## 🚀 Development Workflow

### Getting Started
```bash
# Navigate to mobile directory
cd mobile/expo

# Install dependencies
npm install

# Start development server
npm start

# Run on iOS simulator
npm run ios

# Run on Android emulator  
npm run android
```

### Environment Setup
```bash
# Required environment variables (.env)
EXPO_PUBLIC_DISCOVERY_API_URL=http://localhost:7001/api
EXPO_PUBLIC_INTERACTION_API_URL=http://localhost:7002/api
EXPO_PUBLIC_USER_API_URL=http://localhost:7003/api
EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
```

### Build & Deploy
```bash
# Build for app stores
eas build --platform all

# Submit to stores
eas submit --platform ios
eas submit --platform android

# Preview build
eas build --profile preview
```

---

## ✅ Mobile Development Checklist

### Before Development
- [ ] Expo CLI and EAS CLI installed
- [ ] iOS Simulator / Android Emulator set up
- [ ] Physical devices available for testing
- [ ] Backend services running (discovery, interaction, user)
- [ ] Environment variables configured

### During Development  
- [ ] Test on both iOS and Android regularly
- [ ] Check performance with Flipper
- [ ] Verify haptic feedback works
- [ ] Test gesture interactions
- [ ] Validate API error handling
- [ ] Check offline behavior

### Before Release
- [ ] App store assets prepared (icons, screenshots)
- [ ] Privacy policy and terms updated
- [ ] Push notification setup complete
- [ ] Deep linking tested
- [ ] Performance benchmarks met
- [ ] Accessibility tested (VoiceOver, TalkBack)

---

> **Ready:** Mobile development environment configured with Expo, React Native, and proper integration with existing Stumbleable microservices architecture. Focus on gesture-driven UX and native platform integrations while maintaining feature parity with the web experience.